<?xml version="1.0"?>
<project name="BNU-Bot" default="build" basedir=".">
	<property file="src/net/bnubot/version.properties"/>
	<property file="svn.properties"/>
	<property name="project.dir" value="${svn.checkout.dir}/BNUBot"/>
	
	<path id="project.classpath">
		<fileset dir="lib">
			<include name="**/*.jar"/>
		</fileset>
		<fileset dir="${project.dir}/lib">
			<include name="**/*.jar"/>
		</fileset>
	</path>
	
	<taskdef name="svn" classname="org.tigris.subversion.svnant.SvnTask" classpathref="project.classpath"/>
	
	<target name="update" description="Update BNU-Bot from SVN" >
		<svn username="${svn.username}" password="${svn.password}">
			<checkout url="${svn.url}" destPath="${svn.checkout.dir}"/>
		</svn>
	</target>

	<target name="build" depends="update">
		<svn>
			<status path="${svn.checkout.dir}" revisionProperty="revision" />
		</svn>
		<echo>revision=${revision}</echo>
		<mkdir dir="${project.dir}/bin"/>
		<javac classpathref="project.classpath"
			srcdir="${project.dir}/src"
			destdir="${project.dir}/bin"
			source="1.5"
		/>
		<!-- Get the BUILD_DATE time in seconds -->
		<exec executable="date" outputproperty="TODAY">
			<arg value="+%s"/>
		</exec>
		<property name="vf.src" value="${project.dir}/src/net/bnubot/version.properties" />
		<property name="vf.bin" value="${project.dir}/bin/net/bnubot/version.properties" />
		<delete file="${vf.bin}"/>
		<propertyfile file="${vf.src}">
			<entry key="RELEASE_TYPE" type="string" value="Nightly"/>
			<entry key="VER_SVN_REVISION" type="string" value="${revision}"/>
			<!-- Convert seconds to ms -->
			<entry key="BUILD_DATE" type="string" value="${TODAY}000" />
		</propertyfile>
		<tstamp>
			<format property="TODAY_DATE" pattern="yyyy-MM-dd"/>
		</tstamp>
		<property name="RELEASE_FILE" value="${TODAY_DATE}-r${revision}.jar"/>
		<jar destfile="${release.dir}/${RELEASE_FILE}" manifest="${project.dir}/Dist/Main/MANIFEST.MF">
			<fileset dir="${project.dir}">
				<include name="changelog.txt"/>
			</fileset>
			<fileset dir="${project.dir}/bin">
				<include name="**/*.*"/>
			</fileset>
			<fileset dir="${project.dir}/src">
				<include name="**/*.*"/>
			</fileset>
		</jar>
		<propertyfile file="${release.dir}/LATEST">
			<entry key="LATEST" type="string" value="${RELEASE_FILE}"/>
		</propertyfile>
	</target>
</project>
